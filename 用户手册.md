# 功能简介

Ekar和Ktup均为基于知识图谱的推荐算法模型。

我们的任务是在给定一系列用户和商品的交互记录的基础上，对于每个用户，向他推荐10个他还没有交互过的商品。可以类比淘宝上的"猜你喜欢"功能。

为了完成这个任务，Ekar和Ktup利用了商品的知识图谱作为辅助信息。我们会对每个用户保留一部分他交互过的商品（测试集），用于之后评测我们算法的推荐效果。
我们给模型输入的那部分用户和商品的交互记录就是我们给模型的训练数据（训练集）。两个模型将会从训练集和知识图谱中学习到自己的参数。

训练完成后，两个模型均可以对每个用户推荐10个商品，这10个商品按照模型的打分从大到小排序。比如，排名第一的商品是模型认为用户最可能喜欢的商品。

为了评测推荐质量，对于每个用户和他被推荐的10个商品，我们根据测试集里面用户实际交互过的商品，计算NDCG@10、Precison@10、Recall@10的三个指标。三个指标都是越大越好。

指标的计算：考虑单独一个用户，正例为在测试集中用户交互过的商品集合。设被推荐商品依次为$I_1, I_2, \dots, I_{10}$，打分函数$s(I_j)$，当$I_j$为正例时$s(I_j) = 1$，否则$s(I_j) = 0$。用户正例总数为n

$$
NDCG@10 = \frac{DCG@10}{IDCG@10}\\
其中DCG@10 = \sum_{i=1}^{10}\frac{s(I_i)}{log_2(i+1)}, IDCG@10 = \sum_{i=1}^{min(10,n)}\frac{1}{log_2(i+1)}\\
Precison@10 = 前10名中正例的个数/10=\frac{\sum_{i=1}^{10}s(I_i)}{10}\\
Recall@10 = 前10名中正例的个数/用户的正例总数=\frac{\sum_{i=1}^{10}s(I_i)}{n}
$$


# 数据集

我们的数据集位于~/data/目录下。数据集下载后，经过了统一的预处理，其中包括筛掉没出现在知识图谱中的商品、划分训练集测试集等。保证两个模型输入的训练集、测试集、知识图谱相同。预处理好的movielens数据集位于~/data/movie-one/目录下。(movie代表movielens数据集，one代表用的知识图谱的编号)

在movie-one中，预处理完成后，我们得到以下四个文件，这是Ktup和Ekar模型的输入文件：

train.txt 训练集

eval.txt 验证集

test.txt 测试集

kg.txt 知识图谱

# Ekar操作手册

首先进入目录~/Ekar/

首先将数据集转化为Ekar可以运行的格式。输入如下命令转化，gpu为显卡编号。

```
./movielens-preprocess.sh <gpu>
```

例如

```
./movielens-preprocess.sh 7
```

然后执行以下命令，在movielens数据集上进行Ekar模型的训练。gpu为指定的显卡编号。

```bash
./movielens-train.sh <gpu>
```
例如

```
./movielens-train.sh 7
```

则在7号gpu上进行训练。

出于演示的目的，在这个脚本中，我们只给模型训练了一轮。实际上完整训练的轮数不只一轮。


我们事先训练好了在movielens数据集上完整训练的模型，执行以下命令测试。gpu为指定的显卡编号。


```bash
./movielens-test.sh <gpu>
```

例如

```
./movielens-test.sh 7
```

将会在7号GPU上测试，并得到一系列输出，输出中包含每个用户推荐的10个商品，和最后的三个指标，如下所示（具体数值仅供参考，以真实实验结果为准）：

```
......（以上省略）
user u.141: 716 542 736 514 704 693 759 374 1994 162 
user u.4065: 301 695 721 1512 696 636 341 793 1381 781 
NDCG@10 = 0.3615
Precision@10 = 0.3020
Recall@10 = 0.1952
......（以下省略）

```

# Ktup操作手册

进入目录~/joint-kg-recommender/try1/

对目前的数据集，我们运行以下命令得到Ktup可以运行的数据格式

```bash
bash preprocess.sh <dataset>
```

例如：

```bash
bash preprocess.sh movie
```

然后执行以下命令，在movielens数据集上进行Ktup模型的训练。gpu为指定的显卡编号。

```bash
bash test-movie.sh
```

或者执行命令

```
CUDA_VISIBLE_DEVICES=7 python run_knowledgable_recommendation.py -data_path ./datasets/ -log_path ./log_valid/ -rec_test_files valid.dat:test.dat -kg_test_files valid.dat:test.dat -model_type jtransup -embedding_size 32 -topn 10 -optimizer_type Adam -dataset movie -joint_ratio 0.5 -learning_rate 0.001 -l2_lambda 1e-6 -seed 2 -nohas_visualization
```

则将在7号gpu上对movie数据集进行训练。

训练结果和日志将会保存在所指定的log目录(-log_path)下，这里是保存在./log_valid/目录下。

我们事先训练好了在movielens数据集上完整训练的模型，执行以下命令测试。

```bash
bash eval.sh
```

或者执行命令

```
CUDA_VISIBLE_DEVICES=7 python run_knowledgable_recommendation.py -data_path ./datasets/ -log_path ./log_valid/ -rec_test_files valid.dat:test.dat -kg_test_files valid.dat:test.dat -model_type jtransup -embedding_size 32 -topn 10 -optimizer_type Adam -dataset movie -joint_ratio 0.5 -learning_rate 0.001 -l2_lambda 1e-6 -seed 2 -nohas_visualization  -load_ckpt_file movie-jtransup-1570998891.ckpt -load_experiment_name movie-jtransup-1570998891.ckpt -eval_only_mode
```

将会在7号GPU上测试名为“movie-jtransup-1570998891.ckpt”的模型，并得到一系列输出：包括测试用户及为他们所推荐的item的ID号，以及NDCG@10、Precision@10、Recall@10等三个评价指标。如下所示（具体数值仅供参考，以真实实验结果为准）：

```
......（以上省略）
user: u.141, Top10 IDs: 716 542 736 514 704 693 759 374 1994 162 
user: u.4065, Top10 IDs: 301 695 721 1512 696 636 341 793 1381 781 
p:0.2763, r:0.1568, ndcg:0.3207, topn:10.
......（以下省略）
```

